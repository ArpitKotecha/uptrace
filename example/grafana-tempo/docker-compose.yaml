version: '2'
services:
  # clickhouse:
  #   image: 'yandex/clickhouse-server:21.12'
  #   environment:
  #     - CLICKHOUSE_DB=uptrace
  #   healthcheck:
  #     test: ['CMD', 'wget', '--spider', '-q', 'localhost:8123/ping']
  #     interval: 1s
  #     timeout: 1s
  #     retries: 30

  # uptrace:
  #   image: 'uptrace/uptrace:latest'
  #   volumes:
  #     - ./uptrace.yml:/etc/uptrace/uptrace.yml
  #   ports:
  #     - '14317:14317' # OTLP
  #     - '14318:14318' # UI and HTTP API
  #   environment:
  #     - DEBUG=2
  #   depends_on:
  #     clickhouse:
  #       condition: service_healthy

  tempo:
    image: grafana/tempo:latest
    command: ['-config.file=/etc/tempo.yaml']
    volumes:
      - ./tempo-local.yaml:/etc/tempo.yaml
      - ./tempo-data:/tmp/tempo
    ports:
      - '14268:14268' # jaeger ingest
      - '3200:3200' # tempo
      - '4317:4317' # otlp grpc
      - '4318:4318' # otlp http
      - '9411:9411' # zipkin

  synthetic-load-generator:
    image: omnition/synthetic-load-generator:1.0.25
    volumes:
      - ./load-generator.json:/etc/load-generator.json
    environment:
      - TOPOLOGY_FILE=/etc/load-generator.json
      - JAEGER_COLLECTOR_URL=http://tempo:14268
    depends_on:
      - tempo

  prometheus:
    image: prom/prometheus:latest
    command:
      - --config.file=/etc/prometheus.yaml
      - --web.enable-remote-write-receiver
      - --enable-feature=exemplar-storage
    volumes:
      - ./prometheus.yaml:/etc/prometheus.yaml
    ports:
      - '9090:9090'

  grafana:
    image: grafana/grafana:8.1.6
    volumes:
      - ./grafana-datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    ports:
      - '3000:3000'
